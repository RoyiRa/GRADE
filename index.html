<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="description" content="The homepage for GRADE, a sample diversity metric for text-to-image models.">
  <meta name="keywords" content="Nerfies, D-NeRF, NeRF">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GRADE: a sample diversity metric</title>

  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-PYVRSFMDRL');
  </script>

  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet">

  <link rel="stylesheet" href="./static/css/bulma.min.css">
  <!-- <link rel="stylesheet" href="./static/css/bulma-carousel.min.css"> -->
  <!-- <link rel="stylesheet" href="./static/css/bulma-slider.min.css"> -->
  <!-- <link rel="stylesheet" href="./static/css/fontawesome.all.min.css"> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="./static/css/index.css">
  <link rel="icon" href="./static/images/a_cookie.jpg">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="./static/js/fontawesome.all.min.js"></script>
  <script src="./static/js/bulma-carousel.min.js"></script>
  <!--   <script src="./static/js/bulma-slider.min.js"></script> -->


    <!-- Custom CSS to increase font sizes -->
  <style>

/* Import Google Fonts */
@import url('https://fonts.googleapis.com/css?family=Noto+Sans|Castoro');


/* Define CSS Variables for Dark Theme (Optional) */
@media (prefers-color-scheme: dark) {
  :root {
    --plot-title-color: #87AFC7;     /* Turquoise */
    --question-title-color: #D4B85B; /* Light Blue */
    --subtitle-color: #D4B85B;       /* Khaki */
    --attribute-values-color: #E6E6E6;/* White */
  }
}



    /* Increase font size for accordion buttons */
    .accordion-button {
      font-size: 20px; /* Adjust as needed */
    }

    /* Increase font size for labels */
    .label {
      font-size: 20px; /* Adjust as needed */
      line-height: 50px;

    }
    .control {
      font-size: 20px;
    }


    /* Plot Title */
    .plot-title {
      font-family: 'Noto Sans', sans-serif;
      color: var(--plot-title-color);
      text-align: center;
      margin-bottom: 1em;
      font-size: 1.8em; /* Increased from 1.5em */
    }

    /* Question Title */
    .question-title {
      font-family: 'Noto Sans', sans-serif;
      color: var(--question-title-color);
      text-align: center;
      padding-top: 3em;
      font-size: 1.5em; /* Increased from 1.3em */
    }

  /* Subtitle */
  .subtitle {
    font-family: 'Noto Sans', sans-serif;
    color: var(--subtitle-color);
    text-align: center;
    font-size: 1.3em; /* Increased from 1.1em */
  }

  /* Optional: Attribute Values */
  .attribute-values {
    font-family: 'Noto Sans', sans-serif;
    color: var(--attribute-values-color);
    text-align: center;
    font-size: 1.2em; /* Adjust as needed */
  }

  /* Accordion Button Hover and Focus States */
  .accordion-button {
    transition: background-color 0.3s, color 0.3s;
  }

  .accordion-button:hover {
    background-color: #f0f0f0; /* Light gray background on hover */
    color: var(--plot-title-color); /* Change text color on hover */
  }

  .accordion-button:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 85, 87, 0.25); /* Darker Teal focus ring */
  }

.is-hidden {
  display: none;
}


.default-behavior-indicator {
  display: inline-block;
  width: 1em;
  height: 1em;
  background-color: #ff9999;
  vertical-align: middle;
}



  </style>

</head>

<body>



  <div class="hero">
    <div class="hero-body">
      <div class="container is-max-desktop">
        <!-- Replaced columns with flexbox -->
        <div class="is-flex is-flex-direction-column is-align-items-center">
          <h1 class="title is-1 publication-title has-text-centered">GRADE: Quantifying Sample Diversity <br> in Text-to-Image Models</h1>
          <div class="is-size-5 publication-authors has-text-centered">
            <span class="author-block">
              <a href="https://royi-rassin.netlify.app/">Royi Rassin</a><sup>1</sup>,</span>
            <span class="author-block">
              <a href="https://lovodkin93.github.io/">Aviv Slobodkin</a><sup>1</sup>,</span>
            <span class="author-block">
              <a href="https://shauli-ravfogel.netlify.app/">Shauli Ravfogel</a><sup>1,4</sup>,</span>
            <span class="author-block">
              <a href="https://yanaiela.github.io/">Yanai Elazar</a><sup>2,3</sup>,</span>
            <span class="author-block">
              <a href="https://twitter.com/yoavgo?ref_src=twsrc%5Egoogle%7Ctwcamp%5Eserp%7Ctwgr%5Eauthor">Yoav
                Goldberg</a><sup>1,2</sup>,
            </span>
          </div>

          <div class="is-size-5 publication-authors has-text-centered">
            <span class="author-block">Bar-Ilan University</span><sup>1</sup>
            <span class="author-block">Allen Institute for AI</span><sup>2</sup>
            <span class="author-block">University of Washington</span><sup>3</sup>
            <span class="author-block">ETH ZÃ¼rich</span><sup>4</sup>
          </div>

          <div class="publication-links">
            <span class="link-block">
              <a href="https://arxiv.org/abs/2410.22592" class="external-link button is-normal is-rounded is-dark">
                <span class="icon">
                  <i class="fas fa-file-pdf"></i>
                </span>
                <span>Paper</span>
              </a>
            </span>
            <!-- Code Link -->
            <span class="link-block">
              <a href="https://github.com/RoyiRa/GRADE-Quantifying-sample-diversity-in-text-to-image-models"
                class="external-link button is-normal is-rounded is-dark">
                <span class="icon">
                  <i class="fab fa-github"></i>
                </span>
                <span>Code</span>
              </a>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Abstract. -->
  <div class="hero is-light is-small">
    <div class="hero-body">
      <div class="container is-max-desktop">
        <!-- Replaced columns with flexbox -->
        <div class="is-flex is-justify-content-center">
          <div style="max-width: 80%;">
            <h2 class="title is-3 has-text-centered">The gist</h2>
            <div class="content has-text-justified">
              <p>
                We introduce <strong>GRADE, a method for assessing the output diversity of images generated by text-to-image models</strong>. Using LLMs and Visual-QA systems, GRADE quantifies diversity across concept-specific attributes by estimating attribute distributions and calculating normalized entropy.
                <br><br>
                Our findings reveal substantial homogeneity in T2I outputs, with low diversity across all 12 models we test. Surprisingly, we find bigger and more prompt adherent models deteriorate in diversity. 
                <br><br>
                Finally, we hypothesize that low diversity is due to reporting bias in the training data and show that the diversity in LAION, closely corresponds to the diversity of Stable Diffusion 1 and 2, the models that were trained on it.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
 <!-- GRADE -->
  <div class="hero">
    <div class="hero-body">
      <div class="container is-max-desktop">
        <!-- Replaced columns with flexbox -->
        <div class="is-flex is-justify-content-center">
          <div style="max-width: 80%;">
            <!-- Collapsible Cards -->
            <div class="card">
              <header class="card-header">
                <p class="card-header-title">
                  GRADE
                </p>
                <button class="card-header-icon toggle-card-content" aria-label="toggle content">
                  <span class="icon">
                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                  </span>
                </button>
              </header>
              <div class="card-content is-hidden">
                <div class="content">
                  <p>
                    <!-- GRADE content goes here -->
                  </p>
                </div>
              </div>
            </div>

            <div class="card">
              <header class="card-header">
                <p class="card-header-title">
                  Comparing diversity of text-to-image models
                </p>
                <button class="card-header-icon toggle-card-content" aria-label="toggle content">
                  <span class="icon">
                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                  </span>
                </button>
              </header>
              <div class="card-content is-hidden">
                <div class="content">
                  <p>
                    <!-- Results content goes here -->
                  </p>
                </div>
              </div>
            </div>

            <div class="card">
              <header class="card-header">
                <p class="card-header-title">
                  Is low diversity rooted in the training data?
                </p>
                <button class="card-header-icon toggle-card-content" aria-label="toggle content">
                  <span class="icon">
                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                  </span>
                </button>
              </header>
              <div class="card-content is-hidden">
                <div class="content">
                  <p>
                    <!-- Training Data content goes here -->
                  </p>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>



 <!-- Content after Abstract -->
  <div class="hero is-light is-small">
    <div class="hero-body">
      <div class="container is-max-desktop">

        <!-- Accordion -->
        <!-- Replaced columns with flexbox -->
        <div class="is-flex">
          <div class="flex-item" style="flex: 1;">
            <div class="field">
              <label class="label">Identified attributes for                 
                <div class="select is-rounded is-dark">
                  <select id="concept-select">
                    <!-- Options will be populated by JavaScript -->
                  </select>
                </div>
              </label>
              <div class="control">
                <div class="accordion" id="question-accordion">
                  <!-- Accordion items will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Image Display -->
        <div class="field">
          <label class="label">Showing samples from
            <!-- Model Dropdown Moved Here -->
            <div class="select is-rounded is-dark" style="display: inline-block; margin-left: 10px;">
              <select id="model-select">
                <!-- Options will be populated by JavaScript -->
              </select>
            </div>
          </label>
          <div class="control">
            <img id="result-image" alt="Please select a model and a concept" style="max-width: 100%; height: auto;">
          </div>
        </div>

      </div>
    </div>
  </div>


 <!-- Cite Us -->
  <section class="section" id="BibTeX">
    <div class="container is-centered is-max-desktop content">
      <h2 class="title has-text-centered ">Cite Us ððï¸</h2>
      <pre><code>@misc{rassin2024gradequantifyingsamplediversity,
    title={GRADE: Quantifying Sample Diversity in Text-to-Image Models}, 
    author={Royi Rassin and Aviv Slobodkin and Shauli Ravfogel and Yanai Elazar and Yoav Goldberg},
    year={2024},
    eprint={2410.22592},
    archivePrefix={arXiv},
    primaryClass={cs.CV},
    url={https://arxiv.org/abs/2410.22592}, 
}
</code></pre>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="is-flex is-justify-content-center">
        <div style="max-width: 80%;">
          <div class="content has-text-centered">
            <p>
              This website is licensed under a <a rel="license"
                href="http://creativecommons.org/licenses/by-sa/4.0/">Creative
                Commons Attribution-ShareAlike 4.0 International License</a>.
            </p>
            <p>
              The source code of this website is taken from
              the <a href="https://github.com/nerfies/nerfies.github.io">Nerfies</a> project page.
            </p>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- JavaScript Code -->
  <script>
    // Global variables
    var models = ['sd-1.1', 'sd-1.4', 'sd-2.1', 'sdxl', 'sdxl-turbo', 'lcm-sdxl', 'sd-3', 'flux-dev', 'flux-schnell', 'deepfloyd-l', 'deepfloyd-m', 'deepfloyd-xl'];
      // List of concepts
    var concepts = ['a helmet', 'a bin', 'a telescope', 'a teapot', 'a rug', 'a parachute', 'a table', 'a chair', 'a spinning wheel', 'a ring', 'an ice cream', 'a cake', 'a suitcase', 'a clock', 'a book', 'a bottle', 'a lantern', 'a guitar', 'a uniform', 'a baseball bat', 'yogurt', 'a pair of headphones', 'an umbrella', 'a jewelry box', 'a window', 'a drawer', 'a cookie jar', 'a toolbox', 'a person', 'a balloon', 'a flower', 'a spacesuit', 'a car', 'a sandcastle', 'a sandwich', 'a pair of shoes', 'a torch', 'a neon sign', 'a box', 'an apple', 'a bag', 'a bear', 'a bell', 'hiking boots', 'a clown', 'a crown', 'a mailbox', 'a pot', 'a pillow', 'a pool', 'a popsicle', 'a pretzel', 'a princess', 'a refrigerator', 'a rope', 'a cookie', 'a cup of soda', 'a stick', 'a tie', 'a toy', 'a tree', 'cheese', 'a clothes iron', 'a banana', 'an egg', 'a fish', 'a flashlight', 'a tiara', 'a burger', 'a cow', 'a paintbrush', 'a vase', 'a dice', 'a cupcake', 'a magnifying glass', 'a frisbee', 'a picnic basket', 'a hat', 'a chess piece', 'a puzzle', 'a mask', 'a garden gnome', 'a pacifier', 'a sculpture', 'a tablecloth', 'a brick', 'a witch', 'a detective', 'a present', 'a door', 'a pair of glasses', 'a mirror', 'a coconut', 'a taxi', 'coffee', 'a hot dog', 'soap', 'popcorn', 'corn', 'a stroller'];
    var conceptToQuestions = {};
    firstTimeGridImagesShown = true;

    // Function to parse CSV line
    function parseCSVLine(str) {
      var result = [];
      var cur = '';
      var inQuotes = false;

      for (var i = 0; i < str.length; i++) {
        var c = str[i];

        if (c === '"') {
          if (inQuotes && str[i + 1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (c === ',' && !inQuotes) {
          result.push(cur);
          cur = '';
        } else {
          cur += c;
        }
      }
      result.push(cur);
      return result;
    }

       document.addEventListener('DOMContentLoaded', function () {
      // Initialize all elements with carousel class.
      var carousels = bulmaCarousel.attach('#results-carousel', {
        slidesToScroll: 1,
        slidesToShow: 1,
        pagination: false,
        loop: true,
        autoplay: false,
        autoplaySpeed: 5000,
      });

      // Get references to the select elements
      var modelSelect = document.getElementById('model-select');
      var conceptSelect = document.getElementById('concept-select');
      var resultImage = document.getElementById('result-image');

      // Fetch the CSV file
      jQuery.get('static/grade_benchmark.csv', function (data) {
        parseConceptsQuestionsCSV(data);
      });

      // Function to parse the CSV
      function parseConceptsQuestionsCSV(data) {
        var lines = data.split('\n');
        // Remove header if present
        if (lines[0].startsWith('concept')) {
          lines.shift();
        }

        lines.forEach(function (line) {
          if (line.trim() !== '') {
            var parts = parseCSVLine(line);
            var concept = parts[0];
            var question = parts[1];
            var attribute_values = parts.length > 2 ? parts[2] : '';

            if (!(concept in conceptToQuestions)) {
              conceptToQuestions[concept] = [];
            }
            conceptToQuestions[concept].push({
              question: question,
              attribute_values: attribute_values
            });
          }
        });

        populateConceptDropdown();
        populateModelDropdown();
      }

      // Function to populate the concept dropdown
      function populateConceptDropdown() {
        var conceptDropdown = $('#concept-select');
        conceptDropdown.empty();

        Object.keys(conceptToQuestions).sort().forEach(function (concept) {
          var option = $('<option></option>').attr('value', concept).text(concept);
          conceptDropdown.append(option);
        });

        // Set default value
        conceptDropdown.val('a cake');

        // Remove any existing event listeners
        conceptDropdown.off('change');

        // Add event listener for concept change
        conceptDropdown.on('change', function () {
          var selectedConcept = $(this).val();
          populateQuestionAccordion(selectedConcept);
          if (!firstTimeGridImagesShown) {
            updateImage(); // Update the image when concept changes
          }
        });

        // Trigger change event to populate questions for the first concept
        conceptDropdown.trigger('change');
      }

      // Function to populate the model dropdown
      function populateModelDropdown() {
        var modelDropdown = $('#model-select');
        modelDropdown.empty();

        models.sort().forEach(function (model) {
          var option = $('<option></option>').attr('value', model).text(model);
          modelDropdown.append(option);
        });

        // Set default value
        modelDropdown.val('flux-dev');

        // Remove any existing event listeners
        modelDropdown.off('change');

        // Add event listener for model change
        modelDropdown.on('change', function () {
          updateImage();
        });

        // Trigger change event to update image for the first model
        modelDropdown.trigger('change');
      }

      // Function to update the image based on selections
      function updateImage() {
        var model = modelSelect.value;
        var concept = conceptSelect.value;
        console.log('now testing you mate', model, concept, 'test me now')
        if (model && concept) {
          // Construct the image path
          var imagePath = constructImagePath(model, concept);
          console.log(imagePath, ' wow!')
          // Update the src attribute of the image
          resultImage.src = imagePath;

          // Update the alt attribute
          resultImage.alt = 'Image of ' + concept + ' generated by ' + model;
          firstTimeGridImagesShown = false;
        }
      }

      function constructImagePath(model, concept) {
        // Clean up the concept to match the filename
        var conceptInFilename = concept;

        // Construct the image path
        var imagePath = 'static/images/grid_images/' + model + '/' + model + '_' + conceptInFilename + '_grid_images.jpg';

        return imagePath;
      }

      // Add error handling for the image
      resultImage.addEventListener('error', function () {
        resultImage.src = ''; // Remove the broken image
        alert('Grid Image not found. Please try another combination.');
      });

      // Function to populate the accordion
      function populateQuestionAccordion(concept) {
        $('#selected-concept-display').text(concept);
        var questionAccordion = $('#question-accordion');
        questionAccordion.empty();

        var questionItems = conceptToQuestions[concept];
        questionItems.forEach(function (item, index) {
          var question = item.question;
          var attribute_values = item.attribute_values;

          var buttonLabel = question.toLowerCase() === 'all' ? 'Mean entropy over all attributes' : question;

          // Generate the attribute values list
          var attributeHTML = '';
          if (attribute_values && attribute_values.trim() !== '') {
            attributeList = attribute_values
            // Check and remove the opening bracket
            if (attributeList.startsWith('[')) {
                attributeList = attributeList.substring(1);
            }

            // Check and remove the closing bracket
            if (attributeList.endsWith(']')) {
                attributeList = attributeList.substring(0, attributeList.length - 1);
            }
            var attributeList = attributeList.split(',').map(function (s) { return s.trim(); });
            var letters = 'abcdefghijklmnopqrstuvwxyz';
            attributeHTML = '<h3 style="text-align: center;">';
            attributeList.forEach(function (attribute, idx) {
              var letter = letters.charAt(idx % letters.length);
              attributeHTML += letter + '. ' + attribute;
              if (idx < attributeList.length - 1) {
                attributeHTML += '&nbsp;&nbsp;&nbsp;&nbsp;';
              }
            });
            attributeHTML += '</h3>';
          }

        let conditionalContent = '';
        if (question !== "all") {
          conditionalContent += `
            <!-- Title with added padding -->
            <h1 id="question-title-${index}" style="color: #8c275d; text-align: center; padding-top: 3em;">
              ${question}
            </h1>
            <!-- Subtitle -->
            <h2 style="color: #8c275d; text-align: center;">
              Breakdown by model 
              (<span style="display: inline-block; width: 1em; height: 1em; background-color: #ff9999; vertical-align: middle;"></span> indicates a default behavior)
            </h2>
            <!-- Histogram Grid -->
            <div id="histogram-grid-${index}" class="histogram-grid is-flex is-flex-wrap-wrap is-justify-content-center" style="display: none; padding-top: 3em;">
              <!-- Histograms will be appended here -->
            </div>
          `;
        }

var accordionItem = `
  <!-- Updated Accordion Item -->
  <div class="accordion-item">
    <h2 class="accordion-header" id="heading${index}">
      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
        ${buttonLabel}
      </button>
    </h2>
    <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}">
      <div class="accordion-body">
        <!-- Title Above Plot Image -->
        <h2 class="plot-title">
          Diversity score (normalized entropy) plotted against parameter size
        </h2>
        <!-- Plot Image Div -->
        <div id="plot-div-${index}" class="is-flex is-justify-content-center">
          <img id="plot-image-${index}" src="" alt="Plot will be displayed here" style="max-width: 50%; height: auto; display: none;">
        </div>
        ${
          question !== "all" 
            ? `
              <!-- Title with added padding -->
              <h2 class="question-title">
                ${question}
              </h2>
              <!-- Subtitle -->
              <h2 class="subtitle">
                Breakdown by model 
                (<span style="display: inline-block; width: 1em; height: 1em; background-color: #ff9999; vertical-align: middle;"></span> indicates a default behavior)
              </h2>
            `
            : ''
        }
        <!-- Attribute Values -->
        ${attributeHTML}
        ${
          question !== "all" 
            ? `
              <!-- Histogram Grid -->
              <div id="histogram-grid-${index}" class="histogram-grid" style="display: none; padding-top: 3em;">
                <!-- Histograms will be appended here -->
              </div>
            `
            : ''
        }
      </div>
    </div>
  </div>
`;


          questionAccordion.append(accordionItem);
        });

        // Add click event listener to accordion buttons
        $('#question-accordion .accordion-button').on('click', function () {
          var selectedQuestion = $(this).text().trim();
          var parentAccordionItem = $(this).closest('.accordion-item');
          var index = parentAccordionItem.index(); // Get the index of the accordion item
          var selectedConcept = $('#concept-select').val();

          // Map the button label back to 'all' if necessary
          if (selectedQuestion === 'Mean entropy over all attributes') {
            selectedQuestion = 'all';
          }

          loadPlotImage(selectedConcept, selectedQuestion, index);
        });
      }

      function loadPlotImage(concept, question, index) {
        // Construct the filename based on the concept and question
        var filename = constructPlotFilename(concept, question);
        var filepath = 'static/images/plots/' + filename;

        // Select the specific plot image within the accordion item
        var plotImage = $('#plot-image-' + index);

        // Update the 'src' attribute of the image to display the new plot
        plotImage.attr('src', filepath);

        // Show the image if it's hidden
        plotImage.show();

        // Add error handling in case the image doesn't exist
        plotImage.off('error').on('error', function () {
          alert('Histogram Image not found. Please try another combination.');
          $(this).attr('src', ''); // Clear the 'src' attribute to remove the broken image
          $(this).hide(); // Hide the image if not found
        });

        // Now load the histogram images
        if (question != 'all') {
          loadHistogramImages(concept, question, index);
        }
      }

      function constructPlotFilename(concept, question) {
        // Replace special characters with underscores
        var safeConcept = concept.replace(/[\/\\?%*:|"<>()', ]/g, '_');
        var safeQuestion = question.replace(/[\/\\?%*:|"<>()', ]/g, '_');
        var filename = 'plot_' + safeConcept + '_' + safeQuestion + '.jpg';
        return filename;
      }

      function loadHistogramImages(concept, question, index) {
        // Get the histogram-grid div
        var histogramGrid = $('#histogram-grid-' + index);

        // Clear any existing content
        histogramGrid.empty();

        // Show the histogram grid
        histogramGrid.show();

        // Sanitize concept and question for filenames
        var safeConcept = concept.replace(/[\/\\?%*:|"<>()\', ]/g, '_');
        var safeQuestion = question.replace(/[\/\\?%*:|"<>()\', ]/g, '_');

        // Construct the path to the combined histogram image
        var histogramImagePath = 'static/images/histograms_combined/' + safeConcept + '_' + safeQuestion + '_histogram.jpg';

        // Create the img element
        var img = $('<img>')
          .attr('src', histogramImagePath)
          .attr('alt', 'Histogram for ' + concept + ' - ' + question)
          .css({ 'max-width': '100%', 'height': 'auto' });

        // Add error handling
        img.on('error', function () {
          $(this).attr('src', ''); // Clear the src
          $(this).hide();
          alert('Combined histogram image not found. Please check if the image exists at the specified path.');
        });

        // Append the image to the histogram-grid
        histogramGrid.append(img);
      }

    });
  </script>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // Select all toggle buttons
    var toggleButtons = document.querySelectorAll('.toggle-card-content');

    toggleButtons.forEach(function(button) {
      button.addEventListener('click', function () {
        // Find the closest card container
        var card = button.closest('.card');
        if (!card) return;

        // Find the card-content within this card
        var cardContent = card.querySelector('.card-content');
        if (!cardContent) return;

        // Toggle the 'is-hidden' class to show/hide content
        cardContent.classList.toggle('is-hidden');

        // Toggle the icon direction
        var icon = button.querySelector('i');
        if (cardContent.classList.contains('is-hidden')) {
          icon.classList.remove('fa-angle-up');
          icon.classList.add('fa-angle-down');
        } else {
          icon.classList.remove('fa-angle-down');
          icon.classList.add('fa-angle-up');
        }
      });
    });
  });
  </script>

</body>

